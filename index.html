<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é–©å—èªå¡é€šéŒ„éŸ³å®¤</title>
  <style>
    :root {
      --primary-color: #3498db;
      --success-color: #2ecc71;
      --active-bg: #fff7d6;
    }

    body { 
      font-family: system-ui, -apple-system, sans-serif; 
      margin: 0; 
      background: #f0f2f5; 
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    h2 { margin: 15px; font-size: 1.5rem; color: #333; text-align: center; }

    /* ä¸»è¦å®¹å™¨ï¼šå·¦å³åˆ†å‰² */
    .main-container {
      display: flex;
      flex: 1;
      gap: 20px;
      padding: 0 20px 20px;
      overflow: hidden;
    }

    /* å·¦å´å½±ç‰‡å€ */
    .video-section {
      flex: 1.2;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    video {
      width: 100%;
      background: #000;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }

    /* å³å´æ§åˆ¶èˆ‡åŠ‡æœ¬å€ */
    .control-section {
      flex: 1;
      background: #fff;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      overflow: hidden;
    }

    .top-toolbar {
      padding: 15px;
      border-bottom: 1px solid #eee;
      background: #fff;
    }

    .script-list {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: #fafafa;
    }

    .bottom-players {
      padding: 15px;
      border-top: 1px solid #eee;
      background: #f8f9fa;
    }

    /* æŒ‰éˆ•æ¨£å¼ */
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 8px; }
    button { 
      padding: 10px 14px; 
      border-radius: 8px; 
      border: 1px solid #ddd; 
      background: #fff; 
      cursor: pointer; 
      font-weight: 500;
    }
    button:hover { background: #f8f9fa; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    
    .btn-main { background: var(--primary-color); color: white; border: none; }

    .pill { padding: 4px 12px; border-radius: 999px; background:#e9ecef; font-size: 13px; color: #666; }

    /* åŠ‡æœ¬å¡ç‰‡æ¨£å¼ */
    .line {
      border: 1px solid #e3e3e3;
      background: #fff;
      padding: 14px;
      margin-bottom: 12px;
      border-radius: 10px;
    }
    .line.active { border-left: 6px solid #f1c40f; background: var(--active-bg); }
    .line.done { border-left: 6px solid var(--success-color); }
    
    .role { font-weight: 800; color: #2c3e50; margin-bottom: 5px; display: block; }
    .text { font-size: 1.1rem; line-height: 1.5; color: #34495e; margin-bottom: 10px; }
    
    .line-btns { display: flex; gap: 6px; flex-wrap: wrap; }
    .hint { color:#777; font-size: 13px; line-height: 1.4; }

    /* æ‰‹æ©Ÿæ¨¡å¼ */
    @media (max-width: 900px) {
      .main-container { flex-direction: column; overflow: visible; }
      .control-section { height: auto; }
      .script-list { height: 400px; }
    }
  </style>
</head>
<body>

  <h2>ğŸ™ï¸ é–©å—èªå¡é€šé…éŸ³éŒ„éŸ³å®¤</h2>

  <div class="main-container">
    <div class="video-section">
      <video id="video" src="video.mp4" controls playsinline preload="metadata"></video>
      <div style="padding: 15px; background: #fff; border-radius: 8px;">
        <p class="hint" style="margin:0;"><strong>ğŸ’¡ æ“ä½œå°å®åš€ï¼š</strong><br>
        â€¢ å…ˆæŒ‰ã€Œå…è¨±éº¥å…‹é¢¨ã€æ‰èƒ½é–‹å§‹éŒ„éŸ³ã€‚<br>
        â€¢ éŒ„éŸ³æ™‚å½±ç‰‡æœƒè‡ªå‹•æ’­æ”¾ï¼Œæ™‚é–“åˆ°æœƒè‡ªå‹•åœæ­¢ã€‚</p>
      </div>
    </div>

    <div class="control-section">
      <div class="top-toolbar">
        <div class="row">
          <button id="btnInit" class="btn-main">1) å…è¨±éº¥å…‹é¢¨</button>
          <button id="btnReplayAll" disabled>â–¶ è½é…éŸ³çµæœ</button>
          <button id="btnClear" disabled>ğŸ—‘ æ¸…é™¤å…¨éƒ¨</button>
        </div>
        <div class="row">
          <span id="status" class="pill">å°šæœªåˆå§‹åŒ–</span>
        </div>
        <div class="row" style="font-size: 13px; color: #444;">
          <label><input type="checkbox" id="chkDemoSeek" checked> è½ç¤ºç¯„æ™‚åŒæ­¥è·³åˆ°ç•«é¢</label>
          <label><input type="checkbox" id="chkHearVideo" checked> éŒ„éŸ³æ™‚è½ç¤ºç¯„</label>
          <label style="margin-left:10px;"><input type="checkbox" id="chkAutoNext" checked> éŒ„å®Œè‡ªå‹•ä¸‹ä¸€å¥</label>
        </div>
      </div>

      <div id="script" class="script-list">
        </div>

      <div class="bottom-players">
        <div style="margin-bottom: 8px;">
          <span style="font-size: 12px; color: #888;">ğŸ”Š ç¤ºç¯„æ’­æ”¾ä¸­ï¼š</span>
          <audio id="demoPlayer" controls style="width: 100%; height: 30px;"></audio>
        </div>
        <div>
          <span style="font-size: 12px; color: #888;">ğŸ¤ ä½ çš„å–®å¥éŒ„éŸ³ï¼š</span>
          <audio id="preview" controls style="width: 100%; height: 30px;"></audio>
        </div>
      </div>
    </div>
  </div>

<script>
const singlePlayer = new Audio();
// ç”¨ä¾†è¨˜éŒ„ç›®å‰æ­£åœ¨é‹ä½œçš„ã€Œç¤ºç¯„åœæ­¢ç›£è½å™¨ã€ï¼Œæ–¹ä¾¿åˆ‡æ›æ™‚ç§»é™¤
let currentDemoHandler = null;
(() => {
  const video = document.getElementById('video');
  const btnInit = document.getElementById('btnInit');
  const btnReplayAll = document.getElementById('btnReplayAll');
  const btnClear = document.getElementById('btnClear');
  const statusEl = document.getElementById('status');
  const scriptEl = document.getElementById('script');
  const preview = document.getElementById('preview');
  const demoPlayer = document.getElementById('demoPlayer');

  const chkHearVideo = document.getElementById('chkHearVideo');
  const chkAutoNext = document.getElementById('chkAutoNext');
  const chkDemoSeek = document.getElementById('chkDemoSeek');

  const lines = [
    { "role": "é˜¿å¿—", "text": "è½å¥½ï¼ä»Šå¹´é˜¿å¬¤çš„ç´…åŒ…ç‰¹åˆ¥å¤§åŒ…ï¼Œå’±çµ•å°è¢‚ä½¿æ¼æ°£ï¼", "start": 0, "end": 6.02 },
    { "role": "ç¾ç¾", "text": "å“¼ï¼Œæˆ‘æ—©å°±æº–å‚™å¥½äº†ã€‚ã€Œé‡‘éŠ€è²¡å¯¶æ»¿åå…§ï¼Œå¥½é‹é€™é¦¬ç·Šè½ä¾†ã€ï¼", "start": 6.12, "end": 12.14 },
    { "role": "å¤§èƒ–", "text": "å•Š...æˆ‘åªæƒ³è¦é£Ÿå¹´ç³•...è…¹è‚šå¥½é¤“...", "start": 12.80, "end": 18.17 },
    { "role": "é˜¿å¿—", "text": "è¢‚ä½¿é£Ÿï¼é€™é¦¬é–‹å§‹ç‰¹è¨“ï¼å¤§èƒ–ï¼Œæ›ä½ ï¼ä¸Šå²å®³å½¼å¥ï¼", "start": 18.18, "end": 25.03 },
    { "role": "å¤§èƒ–", "text": "å–”å¥½ï¼ç¥é˜¿å¬¤...èº«é«”å¥åº·...è¬äº‹å¦‚æ„...é£Ÿç™¾äºŒ...", "start": 25.30, "end": 33.03 },
    { "role": "é˜¿å¿—", "text": "å¤ªæ™®é€šå•¦ï¼æ„›é–£è¼ƒæœ‰åŠ›å’§ï¼", "start": 33.24, "end": 41.03 },
    { "role": "é˜¿å¬¤", "text": "ä¹–å­«ï½é˜¿å¬¤ä¾†ç™¼ç´…åŒ…å›‰ï½", "start": 42.60, "end": 47.01 },
    { "role": "ä¸‰äºº", "text": "é˜¿å¬¤ï¼", "start": 47.30, "end": 51.11 },
    { "role": "å¤§èƒ–", "text": "é˜¿å¬¤ï¼ç¥ä½ ...ç¥ä½ ...ã€Œèº«é«”ç¡¬æ¢†æ¢†ã€ï¼", "start": 51.60, "end": 56.14 },
    { "role": "é˜¿å¬¤", "text": "å–”ï½èº«é«”çœŸå‹‡å•¦å¼ï¼çœŸä¹–çœŸä¹–ï¼Œå¤§åŒ…çš„äºˆä½ ï¼", "start": 60.00, "end": 65.10 }
  ];

  let micStream = null;
  let currentIndex = 0;
  const recordings = new Array(lines.length).fill(null);

  const setStatus = (t) => statusEl.textContent = t;

  const seekTo = (videoEl, t) => new Promise((resolve) => {
    const done = () => { videoEl.removeEventListener('seeked', done); resolve(); };
    videoEl.addEventListener('seeked', done);
    videoEl.currentTime = t;
  });

  const render = () => {
    scriptEl.innerHTML = '';
    lines.forEach((l, i) => {
      const div = document.createElement('div');
      div.className = 'line';
      div.id = `line-${i}`;
      if (i === currentIndex) div.classList.add('active');
      if (recordings[i]) div.classList.add('done');

      div.innerHTML = `
        <span class="role">è§’è‰²ï¼š${l.role}</span>
        <div class="text">${l.text}</div>
        <div class="line-btns">
          <button data-act="record" data-i="${i}" ${!micStream ? 'disabled' : ''} style="color:#d35400;">ğŸ¤ éŒ„éŸ³</button>
          <button data-act="demo" data-i="${i}">ğŸ”Š è½ç¤ºç¯„</button>
          <button data-act="goto" data-i="${i}">â© ç•«é¢</button>
          <button data-act="play" data-i="${i}" ${recordings[i] ? '' : 'disabled'}>â–¶ è½éŒ„éŸ³</button>
        </div>
      `;
      scriptEl.appendChild(div);
    });

    btnReplayAll.disabled = !recordings.some(Boolean);
    btnClear.disabled = !recordings.some(Boolean);
  };

  const setActive = (i, { scroll = true } = {}) => {
    currentIndex = Math.max(0, Math.min(i, lines.length - 1));
    render();
    if (scroll) {
      document.getElementById(`line-${currentIndex}`)?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  };

const playDemo = async (i) => {
    setActive(i, { scroll: false });
    const line = lines[i];

    // 1. å¦‚æœä¹‹å‰æœ‰æ­£åœ¨è·‘çš„ç›£è½å™¨ï¼Œå…ˆç§»é™¤æ‰ï¼Œé¿å…å¹²æ“¾
    if (currentDemoHandler) {
      video.removeEventListener('timeupdate', currentDemoHandler);
      currentDemoHandler = null;
    }

    // 2. æº–å‚™æ’­æ”¾ç¤ºç¯„éŸ³æª”
    preview.pause();
    demoPlayer.src = `sample/sample${String(i + 1).padStart(2, '0')}.m4a`;

    // 3. è™•ç†å½±ç‰‡æ’­æ”¾é‚è¼¯
    if (chkDemoSeek.checked) {
      video.muted = true; // è½ç¤ºç¯„æ™‚ï¼Œå»ºè­°æŠŠå½±ç‰‡åŸè²éœéŸ³ï¼Œæ‰è½å¾—æ¸…æ¥šç¤ºç¯„éŸ³
      video.currentTime = line.start;

      // å®šç¾©ï¼šæ™‚é–“åˆ°äº†è¦åšä»€éº¼ (æš«åœ + ç§»é™¤ç›£è½)
      currentDemoHandler = () => {
        if (video.currentTime >= line.end) {
          video.pause();
          video.removeEventListener('timeupdate', currentDemoHandler);
          currentDemoHandler = null;
        }
      };

      // æ›ä¸Šç›£è½å™¨ä¸¦é–‹å§‹æ’­æ”¾å½±ç‰‡
      video.addEventListener('timeupdate', currentDemoHandler);
      video.play().catch((e) => console.log("å½±ç‰‡æ’­æ”¾è¢«é˜»æ“‹æˆ–å¤±æ•—", e));
    }

    // 4. æ’­æ”¾ç¤ºç¯„è²éŸ³
    try {
      await demoPlayer.play();
    } catch (e) {
      console.log("éŸ³æª”æ’­æ”¾å¤±æ•—", e);
    }

    setStatus(`æ’­æ”¾ç¤ºç¯„ï¼šç¬¬ ${i + 1} å¥`);
  };

  const recordLine = async (i) => {
    const line = lines[i];
    setActive(i);
    await seekTo(video, line.start);

    const recorder = new MediaRecorder(micStream);
    const chunks = [];
    video.muted = !chkHearVideo.checked;

    const stopAtEnd = () => {
      video.pause();
      if (recorder.state !== 'inactive') recorder.stop();
      video.removeEventListener('timeupdate', onTime);
    };
    const onTime = () => { if (video.currentTime >= line.end) stopAtEnd(); };

    recorder.ondataavailable = (e) => { if (e.data.size) chunks.push(e.data); };
    recorder.onstop = () => {
      recordings[i] = new Blob(chunks, { type: recorder.mimeType });
      setStatus(`éŒ„éŸ³å®Œæˆï¼`);
      render();
      if (chkAutoNext.checked && i < lines.length - 1) setActive(i + 1);
    };

    video.addEventListener('timeupdate', onTime);
    recorder.start();
    setStatus(`æ­£åœ¨éŒ„è£½ä¸­...`);
    await video.play().catch(()=>{});
  };

  const replayAll = async () => {
    setStatus('æ’­æ”¾æˆå“ä¸­...');
    video.removeAttribute('controls');
    video.currentTime = 0; video.muted = true;
    let nextIdx = 0;

    const onTimeUpdate = () => {
      const t = video.currentTime;
      if (nextIdx < lines.length && t >= lines[nextIdx].start) {
        if (recordings[nextIdx]) {
          setActive(nextIdx);
          singlePlayer.src = URL.createObjectURL(recordings[nextIdx]);
          singlePlayer.play();
        }
        nextIdx++;
      }
      if (nextIdx > 0 && t >= lines[nextIdx-1].end) singlePlayer.pause();
    };

    video.addEventListener('timeupdate', onTimeUpdate);
    video.addEventListener('ended', () => {
      video.setAttribute('controls', '');
      setStatus('å›æ”¾çµæŸ');
    });
    video.play();
  };

  scriptEl.addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const { act, i } = btn.dataset;
    const idx = Number(i);

    if (act === 'record') await recordLine(idx);
    if (act === 'demo') await playDemo(idx);
    if (act === 'goto') { setActive(idx); await seekTo(video, lines[idx].start); }
    if (act === 'play') {
      preview.src = URL.createObjectURL(recordings[idx]);
      preview.play();
    }
  });

  btnInit.addEventListener('click', async () => {
    try {
      micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      btnInit.textContent = "éº¥å…‹é¢¨å·²å°±ç·’ âœ…";
      btnInit.disabled = true;
      setStatus('è«‹é»æ“Šå³å´éŒ„éŸ³æŒ‰éˆ•é–‹å§‹');
      render();
    } catch (err) { alert('è«‹å…è¨±éº¥å…‹é¢¨æ¬Šé™å¾Œé‡æ–°æ•´ç†ç¶²é ã€‚'); }
  });

  btnReplayAll.addEventListener('click', replayAll);
  btnClear.addEventListener('click', () => {
    if(confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰éŒ„éŸ³é‡æ–°é–‹å§‹å—ï¼Ÿ")) { recordings.fill(null); render(); }
  });

  setActive(0);
})();
</script>
</body>
</html>